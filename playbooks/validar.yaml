---
- name: Gestionar contenedores
  hosts: all
  tasks:
    - name: Verificar si Podman está instalado
      command: which podman
      register: podman_check
      failed_when: false

    - name: Verificar si Docker está instalado
      command: which docker
      register: docker_check
      failed_when: false

    - name: Mostrar resultado de la verificación de Podman
      debug:
        msg: "Resultado de Podman (stdout): '{{ podman_check.stdout }}'"

    - name: Mostrar resultado de la verificación de Docker
      debug:
        msg: "Resultado de Docker (stdout): '{{ docker_check.stdout }}'"

    - name: Mostrar código de retorno de Podman
      debug:
        msg: "Código de retorno de Podman: '{{ podman_check.rc }}'"

    - name: Mostrar código de retorno de Docker
      debug:
        msg: "Código de retorno de Docker: '{{ docker_check.rc }}'"

    - name: Establecer gestor de contenedores
    set_fact:
      container_manager: >
        {% if podman_check.stdout | regex_replace('\s+', '') == '/usr/bin/podman' %}
          podman
        {% elif docker_check.stdout | regex_replace('\s+', '') == '/usr/bin/docker' %}
          docker
        {% else %}
          none
        {% endif %}
        
    - name: Mostrar gestor de contenedores detectado
      debug:
        msg: "El gestor de contenedores detectado es: '{{ container_manager }}'"

    - name: Validar si se encontró un gestor de contenedores
      fail:
        msg: "No se encontró Podman ni Docker en este servidor."
      when: container_manager == 'none'

    - name: Ejecutar rol de Podman
      include_role:
        name: podman
      when: container_manager == 'podman'

    - name: Ejecutar rol de Docker
      include_role:
        name: docker
      when: container_manager == 'docker'