---
- name: Gestionar contenedores
  hosts: all
  tasks:
    - name: Verificar si Podman esta instalado
      command: which podman
      register: podman_check
      changed_when: false
      failed_when: false
      become: true

    - name: Verificar si Docker esta instalado
      command: which docker
      register: docker_check
      changed_when: false
      failed_when: false

    - name: Establecer gestor limepiando las entradas
      set_fact:
        container_manager: >
          {% if podman_check.stdout | regex_replace('^\\s+|\\s+$', '') == '/usr/bin/podman' %}
            podman
          {% elif docker_check.stdout | regex_replace('^\\s+|\\s+$', '') == '/usr/bin/docker' %}
            docker
          {% else %}
            none
          {% endif %}
      vars:
        container_manager_cleaned: "{{ container_manager | regex_replace('^\\s+|\\s+$', '') }}"
      
    - name: Limpiar de nuevo por si acaso el gestor
      set_fact:
        container_manager: "{{ container_manager | regex_replace('^\\s+|\\s+$', '') }}"

    - name: Mostrar gestor de contenedores limpio final
      debug:
        var: container_manager

    - name: Verificar si se encontro un gestor de contenedores
      fail:
        msg: "No esta usando contenedores este usuario"
      when: container_manager == 'none'

    - name: Ejecutar rol de Podman
      include_role:
        name: crestart
      become: true     
      when: container_manager == 'podman'

    - name: Ejecutar rol de Docker
      include_role:
        name: docker
      when: container_manager == 'docker'